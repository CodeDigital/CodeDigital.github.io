<!DOCTYPE html>
<html>
<head>

  <link rel="icon" href="../../../assets/img/codeArrowIcon.ico">
  <link href="https://fonts.googleapis.com/css?family=Baloo+Da|Bungee|Encode+Sans|Roboto+Mono|Source+Code+Pro|Roboto" rel="stylesheet">
  <link rel="stylesheet" href="../../../css/stylesheet.css">
  <meta charset="utf-8">
  <title>Beat Defence - &lt;CODE&gt;DIGITAL!</title>
  <meta name="viewport" width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0>
  <style> body {padding: 0; margin: 0;  margin-top: 100px;  text-align: center;} </style>
  <script src="../pulse.js"></script>
  <script src="../p5.min.js"></script>
  <script src="../addons/p5.dom.min.js"></script>
  <script src="../addons/p5.sound.min.js"></script>
  <script src="sketch.js"></script>
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@DigitalDataGame">
  <meta name="twitter:creator" content="@DigitalDataGame">
  <meta name="twitter:title" content="Beat Defence - CODE DIGITAL!">
  <meta name="twitter:description" content="Welcome to CODE DIGITAL. A site I created to house the projects I undertake as a learning programmer.">
  <meta name="twitter:image" content="https://codedigital.github.io/assets/img/twitter-image.png">
  <!-- Schema.org markup for Google+ -->
  <meta itemprop="name" content="Beat Defence - CODE DIGITAL!">
  <meta itemprop="description" content="Welcome to CODE DIGITAL. A site I created to house the projects I undertake as a learning programmer.">
  <meta itemprop="image" content="https://codedigital.github.io/assets/img/twitter-image.png">
  <!-- Open Graph data -->
  <meta property="og:title" content="Beat Defence - CODE DIGITAL!" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://codedigital.github.io/projects/p5/beatdefence/page.html" />
  <meta property="og:image" content="https://codedigital.github.io/assets/img/twitter-image.png" />
  <meta property="og:description" content="Welcome to CODE DIGITAL. A site I created to house the projects I undertake as a learning programmer." />
  <meta property="og:site_name" content="CODE DIGITAL!" />
  <meta property="og:image:height" content="2048px" />
  <meta property="og:image:width" content="4096px" />
  <meta property="fb:app_id" content="2064569620236469">
  <!-- <meta property="fb:admins" content="Facebook numeric ID" /> -->
</head>
<body>
  <header>
    <nav>
      <ul>
        <h2><span style="margin-left:-908px;" class="code">&lt;code&gt;DIGITAL</span></h2>
        <!-- <img src="assets/img/code Digital.png" style="width:15%;display:block;float:left;top:0;"></img> -->
        <li><span class="blank-space">|</span></li>
        <li><a href="../../../contact.html">Contact</a></li>
        <li><a href="../../../projects.html" class="active">My Projects</a></li>
        <!-- <li><a href="../myguy.html">My Guy</a></li> -->
        <li><a href="../../../index.html">Home</a></li>
      </ul>
    </nav>
  </header>
  <a href="../../p5.html" class="backButton" style="margin-top:130px;margin-left:15px;"><span>Back To p5.js Projects</span></a>
  <h1 style="margin-top:-122px;padding:0;">Beat Defence</h1>
  <p style="color:white;margin-top:-60px;margin-left:130px;">My first original game. Defend the earth by shielding it from the missiles moving to the tempo of the music of your choice. Creative Ideation: Jack Barnell. Use "R" to RESTART. UPLOAD MUSIC BELOW!</p>
  <footer>

    <input type="file" id="input"/>
    <script type="text/javascript"> -->
    input.onchange = function(e){
      // var arrayBufferr;
      // var fileReader  = new FileReader;
      // fileReader.onload = function(){
      //    arrayBufferr = this.result;
      //    print(arrayBufferr);
      //    var OfflineContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;
      //    var offlineContext = new OfflineContext(2, 30 * 44100, 44100);
      //
      //    offlineContext.decodeAudioData(arrayBufferr, function(buffer) {
      //
      //      // Create buffer source
      //      var source = offlineContext.createBufferSource();
      //      source.buffer = buffer;
      //
      //      // Beats, or kicks, generally occur around the 100 to 150 hz range.
      //      // Below this is often the bassline.  So let's focus just on that.
      //
      //      // First a lowpass to remove most of the song.
      //
      //      var lowpass = offlineContext.createBiquadFilter();
      //      lowpass.type = "lowpass";
      //      lowpass.frequency.value = 250;
      //      lowpass.Q.value = 1;
      //
      //      // Run the output of the source through the low pass.
      //
      //      source.connect(lowpass);
      //
      //      // Now a highpass to remove the bassline.
      //
      //      var highpass = offlineContext.createBiquadFilter();
      //      highpass.type = "highpass";
      //      highpass.frequency.value = 200;
      //      highpass.Q.value = 1;
      //
      //      // Run the output of the lowpass through the highpass.
      //
      //      lowpass.connect(highpass);
      //
      //      // Run the output of the highpass through our offline context.
      //
      //      highpass.connect(offlineContext.destination);
      //
      //      // Start the source, and render the output into the offline conext.
      //
      //      source.start(0);
      //      offlineContext.startRendering();
      //    });
      //
      //    offlineContext.oncomplete = function(e) {
      //      var buffer = e.renderedBuffer;
      //      var peaks = getPeaks([buffer.getChannelData(0), buffer.getChannelData(1)]);
      //      var groups = getIntervals(peaks);
      //
      //      var top = groups.sort(function(intA, intB) {
      //        return intB.count - intA.count;
      //      }).splice(0, 5);
      //      bpm = Math.round(top[0].tempo);
      //      print("BPM - " + Math.round(top[0].tempo));
      //
      //    };
      //
      //    //snippet.log(arrayBuffer);
      //    //snippet.log(arrayBuffer.byteLength);
      //    }
      // fileReader.readAsArrayBuffer(this.files[0]);
      // //print(arrayBufferr);
      // function getPeaks(data) {
      //
      //   // What we're going to do here, is to divide up our audio into parts.
      //
      //   // We will then identify, for each part, what the loudest sample is in that
      //   // part.
      //
      //   // It's implied that that sample would represent the most likely 'beat'
      //   // within that part.
      //
      //   // Each part is 0.5 seconds long - or 22,050 samples.
      //
      //   // This will give us 60 'beats' - we will only take the loudest half of
      //   // those.
      //
      //   // This will allow us to ignore breaks, and allow us to address tracks with
      //   // a BPM below 120.
      //
      //   var partSize = 22050,
      //   parts = data[0].length / partSize,
      //   peaks = [];
      //
      //   for (var i = 0; i < parts; i++) {
      //     var max = 0;
      //     for (var j = i * partSize; j < (i + 1) * partSize; j++) {
      //       var volume = Math.max(Math.abs(data[0][j]), Math.abs(data[1][j]));
      //       if (!max || (volume > max.volume)) {
      //         max = {
      //           position: j,
      //           volume: volume
      //         };
      //       }
      //     }
      //     peaks.push(max);
      //   }
      //
      //   // We then sort the peaks according to volume...
      //
      //   peaks.sort(function(a, b) {
      //     return b.volume - a.volume;
      //   });
      //
      //   // ...take the loundest half of those...
      //
      //   peaks = peaks.splice(0, peaks.length * 0.5);
      //
      //   // ...and re-sort it back based on position.
      //
      //   peaks.sort(function(a, b) {
      //     return a.position - b.position;
      //   });
      //
      //   return peaks;
      // }
      //
      // function getIntervals(peaks) {
      //
      //   // What we now do is get all of our peaks, and then measure the distance to
      //   // other peaks, to create intervals.  Then based on the distance between
      //   // those peaks (the distance of the intervals) we can calculate the BPM of
      //   // that particular interval.
      //
      //   // The interval that is seen the most should have the BPM that corresponds
      //   // to the track itself.
      //
      //   var groups = [];
      //
      //   peaks.forEach(function(peak, index) {
      //     for (var i = 1; (index + i) < peaks.length && i < 10; i++) {
      //       var group = {
      //         tempo: (60 * 44100) / (peaks[index + i].position - peak.position),
      //         count: 1
      //       };
      //
      //       while (group.tempo <= 90) {
      //         group.tempo *= 2;
      //       }
      //
      //       while (group.tempo > 180) {
      //         group.tempo /= 2;
      //       }
      //
      //       group.tempo = Math.round(group.tempo);
      //
      //       if (!(groups.some(function(interval) {
      //         return (interval.tempo === group.tempo ? interval.count++ : 0);
      //       }))) {
      //         groups.push(group);
      //       }
      //     }
      //   });
      //   return groups;
      // }
      //
      //
      //
      //
      //
      //

      //var song = document.getElementById('sound');
      var src;
      if(playing){
        audio.stop();
        backing.stop();
      }
      score = 0;
      health = maxH;
      ready = false;
      playing = false;
      src = URL.createObjectURL(this.files[0]);
      var uri = URL.createObjectURL(this.files[0]);
      var pulse = new Pulse({

        // when Pulse has finished to compute main data: beat, significant peaks...
        onComplete: function(event, pulse) {
          var extrapolatedPeaks = pulse.getExtrapolatedPeaks(
            pulse.renderedBuffer,
            pulse.significantPeaks,
            pulse.beat
          );

          // beat (ms and bpm properties)
          print(pulse.beat);
          print(pulse.beat.bpm);

          // extrapolated peaks
          print(extrapolatedPeaks);
        }
      });

      pulse.loadBufferFromURI(uri);

      audio = loadSound(src,function(){
        backing = loadSound(src,function(){
          health = maxH;
          score = 0;
          ready = true;
        });
      });
      //audio = loadSound(src);

      // not really needed in this exact case, but since it is really important in other cases,
      // don't forget to revoke the blobURI when you don't need it
      //song.onend = function(e) {
      //URL.revokeObjectURL(src);
      //}
    }
    <!-- // </script>

    <span style="padding-left:20px;"></span>Site Created by <a class="code" href="https://github.com/DigitalData">DigitalData</a>.
  </footer>
</body>
</html>
